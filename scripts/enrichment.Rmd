---
title: "enrichment"
output: html_document
date: "2023-04-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Seting analysis parameters:



# GO term enrichemnt

Loading library:
```{r}
library(goseq)
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
main_folder <- "../results/"
ddseq_file <- "../resutls/dds.RData"
group_1 <- "Grupa_2"
group_2 <- "Grupa_3"
```


Reading in data:

```{r cars}
table_all <- read.csv(file = paste0(main_folder, group_1, group_2, "DA_all.csv"))
table_all <- table_all[!is.na(table_all$padj), ]
df <- data.frame(x = table_all$X)
df <- df %>% extract(x,"A")
row.names(table_all) <- df$A
head(table_all)
```

Checking which genes were DE:

```{r pressure, echo=FALSE}
genes2 <- as.integer(table_all$padj<0.05)
names(genes2) = row.names(table_all)
table(genes2)
```

Running analysis:

```{r}
pwf=nullp(genes2,"hg19","ensGene")
head(pwf)

GO.wall=goseq(pwf,"hg19","ensGene")
GO.wall$over_pvalue_adj <- p.adjust(GO.wall$over_represented_pvalue, method = "BH")
GO.wall$under_pvalue_adj <- p.adjust(GO.wall$under_represented_pvalue, method = "BH")

write.csv(GO.wall, 
          file=paste0(main_folder, group_1, group_2, "go_res.csv"))

```

```{r}

groups <- c('Grupa_1Grupa_2', 'Grupa_1Grupa_3', 'Grupa_2Grupa_3')

for(i in groups){
  print(i)
  go <- read.csv(paste0(main_folder, i, "go_res.csv"))
  go$over_pvalue_adj <- p.adjust(go$over_represented_pvalue, method = "BH")
  go$under_pvalue_adj <- p.adjust(go$under_represented_pvalue, method = "BH")
  
  print(go[go$over_pvalue_adj < 0.05,])
  print(go[go$under_pvalue_adj < 0.05,])
  
}

```



# GSEA

Setting analysis parameters:
```{r cars}
db <- "c5.go.bp.v2022.1.Hs.entrez.gmt"
db_name <- "GO_term"
```

Loading libraries:

```{r}
library(fgsea)
library(data.table)
library(ggplot2)
library(dplyr)
library(tidyr)
library(biomaRt)
library(httr)
library(ggplot2)
library(forcats)
httr::set_config(config(ssl_verifypeer = 0L))
```

Running analysis:

```{r}
rank <- read.csv(file = paste0(main_folder, folder, group_1, group_2, "DA_0_05.csv"))
rank <- rank[order(rank$log2FoldChange),] 
rank_ensembl <- rank$X



mart <- useEnsembl("ensembl","hsapiens_gene_ensembl", mirror = "useast")
G_list <- getBM(filters= "ensembl_gene_id", attributes= c("ensembl_gene_id",
                                                          "hgnc_symbol"),
                values=rank_ensembl, mart= mart)

rank_id <- as.character(G_list[match(rank_ensembl, G_list$ensembl_gene_id), 'hgnc_symbol'])
rank_id_val  <- rank$log2FoldChange
names(rank_id_val) <- rank_id
rank_id_val <- rank_id_val[!is.na(names(rank_id_val))]
rank_id_val <- rank_id_val[!duplicated(names(rank_id_val))]

gmt.file <- system.file("extdata", db, package="fgsea")
pathways <- gmtPathways(gmt.file)

print(head(rank_id_val))
print(tail(rank_id_val))
fgseaRes <- fgsea(pathways, rank_id_val, maxSize=500)
fgseaRes <- fgseaRes[order(padj), ]
fwrite(fgseaRes, file=paste0(main_folder, folder, group_1, group_2, "_", db_name ,"_GSEA.csv"), sep=",", sep2=c("", " ", ""))
```

Choosing significant terms:

```{r}
db_name <- 'tft'
db_name_plot <- 'TFT'
# go_type<- "GOMF" # GOCC, GOBP

groups <- c('Grupa_1Grupa_2', 'Grupa_1Grupa_3', 'Grupa_2Grupa_3')

topPathways_all <-NULL
df_list <- list(1, 2, 3)
names(df_list) <- c('Grupa_1Grupa_2', 'Grupa_1Grupa_3', 'Grupa_2Grupa_3')


for(i in groups){
  gsea <- read.csv(paste0(main_folder, i, "/" , i, "_", db_name ,
                            "_GSEA_hgnc.csv"))
  # gsea <- gsea %>% filter(grepl(go_type, pathway))
  df_list[[i]] <- gsea
  gsea <- gsea[gsea$padj < 0.05, ]
  
  topPathways <- gsea[head(order(gsea$padj), n=5), 'pathway']
  topPathways_all <-c(topPathways_all,topPathways)
  
}

topPathways_all
```

Making a plot of results:

```{r}
library(forcats)
df = NULL
df_names <- c('Grupa 1 vs 2', 'Grupa 1 vs 3', 'Grupa 2 vs 3')
for(i in groups){
  g <- df_list[[i]]

  d <- g[g$pathway %in% topPathways_all,]

  d$sample <- i

  df <- rbind(df,d)
}
scale = c(1, 10, 100, 1000, 10000)



df <- df %>%
  mutate(pathway = fct_reorder(pathway, NES))
p <- ggplot(data=df, aes(x=sample,
             y=pathway,
             colour=NES,
             size=1/padj)) +
  geom_point() +
  labs(y= paste(db_name_plot, "term"), x='', colour="NES", size="FDR")  +
  scale_size(labels=1/scale,breaks=scale,trans = 'log10') +
  scale_color_gradient2(low="blue", mid="white", high="red", space ="Lab" ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), text = element_text(size = 8))

pdf(paste0("../plots/", db_name, ".pdf"), useDingbats=TRUE, width =6, height = 3.5)
p
dev.off()

```

